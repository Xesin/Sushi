(function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,t.XEngine=e()}})(function(){return function p(d,e,t){function r(i,o){if(!e[i]){if(!d[i]){var s="function"==typeof require&&require;if(!o&&s)return s(i,!0);if(n)return n(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var m=e[i]={exports:{}};d[i][0].call(m.exports,function(t){var e=d[i][1][t];return r(e?e:t)},m,m.exports,p,d,e,t)}return e[i].exports}for(var n="function"==typeof require&&require,a=0;a<t.length;a++)r(t[a]);return r}({1:[function(){"use strict";var e,r=Math.sqrt,o=Math.sin,a=Math.cos,t=Math.min,i=Math.round,n=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}();(function(e){var t=function(){function t(t){this.game=t,this.onKeyDown=new e.Signal,this.onKeyUp=new e.Signal,this.onClick=new e.Signal,this.onInputDown=new e.Signal,this.onInputUp=new e.Signal,this.onInputMove=new e.Signal,this.pointerDown=!1,this.pointer=new e.Vector(0);var r=this;document.addEventListener("keydown",function(e){r.keyDownHandler.call(r,e)}),document.addEventListener("keyup",function(e){r.keyUpHandler.call(r,e)}),this.game.isMobile?(this.game.canvas.addEventListener("touchstart",function(e){r.inputDownHandler.call(r,e)}),this.game.canvas.addEventListener("touchend",function(e){r.inputUpHandler.call(r,e)}),this.game.canvas.addEventListener("touchmove",function(e){r.inputMoveHandler.call(r,e)})):(this.game.canvas.addEventListener("mousedown",function(e){r.inputDownHandler.call(r,e)}),this.game.canvas.addEventListener("mouseup",function(e){r.inputUpHandler.call(r,e)}),this.game.canvas.addEventListener("mousemove",function(e){r.inputMoveHandler.call(r,e)}),this.game.canvas.addEventListener("click",function(e){r.clickHandler.call(r,e)})),this._initializeKeys()}return t.prototype._initializeKeys=function(){for(var t in this.keysPressed=[],e.KEY_CODE)this.keysPressed[t]=!1},t.prototype.isPressed=function(e){return this.keysPressed[e]},t.prototype.reset=function(){this.onKeyUp._destroy(),this.onKeyDown._destroy(),this.onClick._destroy(),this.onInputDown._destroy(),this.onInputUp._destroy(),this.onInputMove._destroy(),this._initializeKeys()},t.prototype.keyDownHandler=function(e){this.keysPressed[e.keyCode]||(this.keysPressed[e.keyCode]=!0,this.onKeyDown.dispatch(e))},t.prototype.keyUpHandler=function(e){this.keysPressed[e.keyCode]=!1,this.onKeyUp.dispatch(e)},t.prototype.inputDownHandler=function(){this.pointerDown=!0;var t=this.getInputPosition(event);this.pointer.x=t.position.x,this.pointer.y=t.position.y,this.onInputDown.dispatch(t);var r=this,o=function(a){for(var n,p=a.length-1;0<=p;p--)if(n=a[p],!e.Group.prototype.isPrototypeOf(n)){if(!n.inputEnabled)continue;if(r._pointerInsideBounds(n))return void 0===n.onInputDown&&(n.onInputDown=new e.Signal),n.onInputDown.dispatch(event),n.isInputDown=!0,n.downPos.setTo(t.position.x,t.position.y),n.posWhenDown.setTo(n.position.x,n.position.y),!0}else if(o(n.children))return!0;return!1};o(this.game.updateQueue)},t.prototype.inputUpHandler=function(){this.pointerDown=!1;var t={position:{x:this.pointer.x,y:this.pointer.y}};this.game.isMobile&&this.clickDispatcher(t),this.onInputUp.dispatch(t);var r=this,o=function(t){for(var r,a=t.length-1;0<=a;a--)if(r=t[a],e.Group.prototype.isPrototypeOf(r))o(r.children);else{if(!r.inputEnabled)continue;if(r.isInputDown)return void 0===r.onInputUp&&(r.onInputUp=new e.Signal),r.onInputUp.dispatch(event),r.isInputDown=!1,!0}};o(this.game.updateQueue)},t.prototype.inputMoveHandler=function(){var t=this.getInputPosition(event);this.pointer.x=t.position.x,this.pointer.y=t.position.y;var r=this,o=function(a){for(var n,p=a.length-1;0<=p;p--)if(n=a[p],e.Group.prototype.isPrototypeOf(n))o(n.children);else{if(!n.inputEnabled)continue;r._pointerInsideBounds(n)?!n.isInputOver&&(void 0===n.onInputOver&&(n.onInputOver=new e.Signal),n.onInputOver.dispatch(event),n.isInputOver=!0):n.isInputOver&&(void 0===n.onInputLeft&&(n.onInputLeft=new e.Signal),n.onInputLeft.dispatch(event),n.isInputOver=!1),n.pickeable&&n.isInputDown&&n.position.setTo(n.posWhenDown.x-(n.downPos.x-t.position.x),n.posWhenDown.y-(n.downPos.y-t.position.y))}};this.onInputMove.dispatch(t),o(this.game.updateQueue)},t.prototype.clickHandler=function(e){var t=this.getInputPosition(e);this.clickDispatcher(t)},t.prototype.clickDispatcher=function(t){this.onClick.dispatch(t);var r=this,o=function(a){for(var n,p=a.length-1;0<=p;p--)if(n=a[p],e.Group.prototype.isPrototypeOf(n)){if(o(n.children))return!0;}else if((n||n.inputEnabled)&&r._pointerInsideBounds(n))return void 0===n.onClick&&(n.onClick=new e.Signal),n.onClick.dispatch(t),!0;return!1};o(this.game.updateQueue)},t.prototype._pointerInsideBounds=function(e){if(void 0!==e.getBounds){var t=e.getBounds(),r=e.getWorldPos();return this.pointer.x<r.x-t.width*e.anchor.x||this.pointer.x>r.x+t.width*(1-e.anchor.x)?!1:this.pointer.y<r.y-t.height*e.anchor.y||this.pointer.y>r.y+t.height*(1-e.anchor.y)?!1:!0}return!1},t.prototype.getInputPosition=function(e){var t=this.game.canvas.getBoundingClientRect(),r={position:{x:e.pageX-(document.documentElement.scrollLeft||document.body.scrollLeft)-t.left,y:e.pageY-(document.documentElement.scrollTop||document.body.scrollTop)-t.top}};return this.game.isMobile&&(r={position:{x:e.touches[0].pageX-(document.documentElement.scrollLeft||document.body.scrollLeft)-t.left,y:e.touches[0].pageY-(document.documentElement.scrollTop||document.body.scrollTop)-t.top}}),r.position.x/=this.game.renderer.scale.x,r.position.y/=this.game.renderer.scale.y,r},t}();e.InputManager=t})(e||(e={}));var e;(function(e){var t;(function(e){e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT=16]="SHIFT",e[e.CTRL=17]="CTRL",e[e.ALT=18]="ALT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESC=27]="ESC",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.LEFT=37]="LEFT",e[e.UP=38]="UP",e[e.RIGHT=39]="RIGHT",e[e.DOWN=40]="DOWN",e[e.PRINT_SCREEN=42]="PRINT_SCREEN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.ZERO=48]="ZERO",e[e.ONE=49]="ONE",e[e.TWO=50]="TWO",e[e.THREE=51]="THREE",e[e.FOUR=52]="FOUR",e[e.FIVE=53]="FIVE",e[e.SIX=54]="SIX",e[e.SEVEN=55]="SEVEN",e[e.EIGHT=56]="EIGHT",e[e.NINE=57]="NINE",e[e.A=65]="A",e[e.B=66]="B",e[e.C=67]="C",e[e.D=68]="D",e[e.E=69]="E",e[e.F=70]="F",e[e.G=71]="G",e[e.H=72]="H",e[e.I=73]="I",e[e.J=74]="J",e[e.K=75]="K",e[e.L=76]="L",e[e.M=77]="M",e[e.N=78]="N",e[e.O=79]="O",e[e.P=80]="P",e[e.Q=81]="Q",e[e.R=82]="R",e[e.S=83]="S",e[e.T=84]="T",e[e.U=85]="U",e[e.V=86]="V",e[e.W=87]="W",e[e.X=88]="X",e[e.Y=89]="Y",e[e.Z=90]="Z",e[e.PAD0=96]="PAD0",e[e.PAD1=97]="PAD1",e[e.PAD2=98]="PAD2",e[e.PAD3=99]="PAD3",e[e.PAD4=100]="PAD4",e[e.PAD5=101]="PAD5",e[e.PAD6=102]="PAD6",e[e.PAD7=103]="PAD7",e[e.PAD8=104]="PAD8",e[e.PAD9=105]="PAD9",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.SEMICOLON=186]="SEMICOLON",e[e.PLUS=187]="PLUS",e[e.COMMA=188]="COMMA",e[e.MINUS=189]="MINUS",e[e.PERIOD=190]="PERIOD",e[e.FORWAD_SLASH=191]="FORWAD_SLASH",e[e.BACK_SLASH=220]="BACK_SLASH",e[e.QUOTES=222]="QUOTES"})(t=e.KEY_CODE||(e.KEY_CODE={}))})(e||(e={}));var e;(function(e){var t=function(){function t(t,r,o,a){this.rate=a,this.currentFrame=0,this.loop=!1,this.playing=!1,this.onComplete=new e.Signal,this.game=t,this.sprite=r,this.frames=o,this.maxFrames=o.length-1,this.frameTime=0}return t.prototype.update=function(e){if(this.frameTime+=e,this.frameTime>=this.rate&&(this.currentFrame++,this.frameTime=0,this.currentFrame>this.maxFrames))if(this.loop)this.currentFrame=0;else return this.stop(),void this.onComplete.dispatch();this.sprite.frame=this.frames[this.currentFrame]},t.prototype.start=function(){this.playing=!0},t.prototype.stop=function(){this.playing=!1,this.frameTime=0,this.currentFrame=0},t}();e.Animation=t})(e||(e={}));var e;(function(e){var t=function(){function t(e,t){this.game=e,this.sprite=t,this.animations=[],this.currentAnimation=null}return t.prototype.update=function(e){this.currentAnimation&&this.currentAnimation.playing&&this.currentAnimation.update(e)},t.prototype.play=function(e){this.currentAnimation&&this.animations[e]!==this.currentAnimation&&this.currentAnimation.stop();var t=this.animations[e];if(t)return this.currentAnimation=t,t._start(),this.currentAnimation},t.prototype.stop=function(e){var t=this.animations[e];t&&(this.currentAnimation=null,t._stop())},t.prototype.add=function(t,r,o,a){void 0===a&&(a=!1);var i=new e.Animation(this.game,this.sprite,r,o);i.loop=a,this.animations[t]=i},t}();e.AnimationManager=t})(e||(e={}));var e;(function(e){var t=function(){function t(t,r,o){void 0===r&&(r=0),void 0===o&&(o=0),this.game=t,this.parent=t,this.isPendingDestroy=!1,this.alive=!0,this.alpha=1,this.scale=new e.Vector(1,1),this.anchor=new e.Vector(0,0),this.rotation=0,this.position=new e.Vector(r,o),this.onClick=new e.Signal,this.onInputDown=new e.Signal,this.onInputUp=new e.Signal,this.onInputOver=new e.Signal,this.onInputLeft=new e.Signal,this.inputEnabled=!1,this.render=!0,this.fixedToCamera=!1,this.isometric=!1,this.isInputDown=!1,this.width=0,this.height=0,this._prevWidth=0,this._prevHeight=0,this._prevPos={x:0,y:0},this.shader=null,this._vertDataBuffer=new e.DataBuffer32(96),this._uv=[0,0,0,1,1,0,1,1],this.gl=this.game.context;var a=this.gl,i=new e.DataBuffer16(12);this.vertexBuffer=this.game.renderer.resourceManager.createBuffer(a.ARRAY_BUFFER,this._vertDataBuffer.getByteCapacity(),a.STREAM_DRAW),this.indexBuffer=this.game.renderer.resourceManager.createBuffer(a.ELEMENT_ARRAY_BUFFER,this._vertDataBuffer.getByteCapacity(),a.STATIC_DRAW);for(var n=i.uintView,p=0,s=0;6>p;p+=6,s+=4)n[p+0]=s+0,n[p+1]=s+1,n[p+2]=s+2,n[p+3]=s+1,n[p+4]=s+3,n[p+5]=s+2;this.indexBuffer.updateResource(n,0),this.mask=null,this.mvMatrix=mat4.create(),mat4.identity(this.mvMatrix),this.pickeable=!1,this.downPos=new e.Vector(0,0),this.posWhenDown=new e.Vector(0,0),this.color=16777215}return t.prototype.destroy=function(){this.kill(),this.isPendingDestroy=!0,void 0!==this.onDestroy&&this.onDestroy()},t.prototype.onDestroy=function(){},t.prototype._onInitialize=function(){this.shader&&(!this.shader.compiled&&this.shader.initializeShader(this.gl),this._setBuffers())},t.prototype.setColor=function(e,t){void 0===t&&(t=1),this.color=e,this.alpha=t,this._setVertices(this.width,this.height,this.color,this._uv)},t.prototype.kill=function(){this.alive=!1},t.prototype.restore=function(e,t){this.position.x=e,this.position.y=t,this.alive=!0},t.prototype.getWorldMatrix=function(t){this.parent.getWorldMatrix(t);var r=[this.position.x,this.position.y,0],o=i(-(this.width*this.anchor.x)),a=i(-(this.height*this.anchor.y));return this.fixedToCamera&&(r[0]+=this.game.camera.position.x,r[1]+=this.game.camera.position.y),mat4.translate(t,t,r),mat4.rotateZ(t,t,this.rotation*e.Mathf.TO_RADIANS),mat4.scale(t,t,[this.scale.x,this.scale.y,1]),mat4.translate(t,t,[o,a,0]),t},t.prototype.getWorldPos=function(){var t=this.parent.getWorldPos(),r=this.position.x+t.x,o=this.position.y+t.y;return new e.Vector(r,o)},t.prototype._beginRender=function(e){this.shader&&this.shader._beginRender(e),this.game.renderer.setRenderer(null,null)},t.prototype._renderToCanvas=function(e){this.shader.baseUniforms.pMatrix.value=this.game.camera.pMatrix,this.shader.updateUniforms(e),(this._prevHeight!==this.height||this._prevWidth!==this.width||this._prevPos.x!==this.position.x||this._prevPos.y!==this.position.y)&&(this._setVertices(this.width,this.height,this.color,this._uv),this._prevHeight=this.height,this._prevWidth=this.width,this._prevPos.x=this.position.x,this._prevPos.y=this.position.y),this.vertexBuffer.bind(),this.indexBuffer.bind(),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0)},t.prototype.rendermask=function(e){if(e.colorMask(!1,!1,!1,!1),e.stencilFunc(e.ALWAYS,1,1),e.stencilOp(e.REPLACE,e.REPLACE,e.REPLACE),e.enable(e.STENCIL_TEST),this.sprite){var t=this.game.cache.image(this.sprite);this.shader._setTexture(t._texture)}this.shader._beginRender(e),this.shader.baseUniforms.pMatrix.value=this.game.camera.pMatrix,this.shader.updateUniforms(e),this._setVertices(this.width,this.height,this.color,this._uv),this.vertexBuffer.bind(),this.indexBuffer.bind(),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),e.stencilFunc(e.EQUAL,1,1),e.stencilOp(e.ZERO,e.ZERO,e.ZERO),e.colorMask(!0,!0,!0,!0)},t.prototype.endRendermask=function(e){e.disable(e.STENCIL_TEST),e.clear(e.STENCIL_BUFFER_BIT)},t.prototype._endRender=function(){null!=this.mask},t.prototype.getBounds=function(){var e=this.width*this.scale.x,t=this.height*this.scale.y,r=this.getWorldPos(),o=e*this.anchor.x,a=t*this.anchor.y,i=r.x-o,n=r.x+e-o,p=r.y-a,s=r.y+t-a;return{width:e,height:t,minX:i,maxX:n,minY:p,maxY:s}},t.prototype.isInsideCamera=function(){var e=this.getBounds(),t=this.getWorldPos(),r=this.game.camera.position,o={width:this.game.width,height:this.game.height};return!(e.maxX<r.x)&&!(e.maxY<r.y)&&!(e.minX>r.x+o.width)&&!(e.minY>r.y+o.height)},t.prototype.start=function(){},t.prototype.update=function(){},t.prototype._setVertices=function(t,r,o,a){var i=this._vertDataBuffer.floatView,n=this._vertDataBuffer.uintView,p=0,s=new e.Vector(0,0);this.getWorldMatrix(this.mvMatrix),s=s.multiplyMatrix(this.mvMatrix),i[p++]=s.x,i[p++]=s.y,i[p++]=a[0],i[p++]=a[1],n[p++]=o,i[p++]=this.alpha,s.setTo(0,this.height),s=s.multiplyMatrix(this.mvMatrix),i[p++]=s.x,i[p++]=s.y,i[p++]=a[2],i[p++]=a[3],n[p++]=o,i[p++]=this.alpha,s.setTo(this.width,0),s=s.multiplyMatrix(this.mvMatrix),i[p++]=s.x,i[p++]=s.y,i[p++]=a[4],i[p++]=a[5],n[p++]=o,i[p++]=this.alpha,s.setTo(this.width,this.height),s=s.multiplyMatrix(this.mvMatrix),i[p++]=s.x,i[p++]=s.y,i[p++]=a[6],i[p++]=a[7],n[p++]=o,i[p++]=this.alpha,this.vertexBuffer.updateResource(i,0)},t.prototype._setBuffers=function(){var e=this.gl;this.shader.bind(e),this.vertexBuffer.addAttribute(this.shader.vertPosAtt,2,e.FLOAT,!1,24,0),this.vertexBuffer.addAttribute(this.shader.vertUvAtt,2,e.FLOAT,!1,24,8),this.vertexBuffer.addAttribute(this.shader.vertColAtt,3,e.UNSIGNED_BYTE,!0,24,16),this.vertexBuffer.addAttribute(this.shader.vertAlphaAtt,1,e.FLOAT,!1,24,20)},t}();e.GameObject=t})(e||(e={}));var e;(function(e){var t=function(t){function r(r,o,a,i){var n=t.call(this,r,0,0)||this;return n.isLoop=!1,n.audio=n.game.cache.audio(o).audio,n.persist=!1,n.volume=i||1,n.onComplete=new e.Signal,n.completed=!1,a&&n.play(0),n}return n(r,t),r.prototype.update=function(){null!=this.gainNode&&(this.gainNode.gain.value=this.volume)},r.prototype.play=function(e){var t=this;this.source=this.game.audioContext.createBufferSource(),this.source.buffer=this.audio,this.source.connect(this.game.audioContext.destination),this.source.onended=function(){t._complete()},this.gainNode=this.game.audioContext.createGain(),this.source.connect(this.gainNode),this.gainNode.connect(this.game.audioContext.destination),this.gainNode.gain.value=this.volume,this.source.loop=this.isLoop,this.source.start(e||0)},r.prototype.stop=function(e){void 0===e&&(e=0),this.source&&this.source.stop(e||0)},r.prototype.loop=function(e){this.isLoop=e},r.prototype.destroy=function(){t.prototype.destroy.call(this),this.onComplete&&(this.onComplete._destroy(),delete this.onComplete)},r.prototype.kill=function(){this.alive=!1,this.stop()},r.prototype._complete=function(){this.stop(),this.onComplete&&this.onComplete.dispatch()},r}(e.GameObject);e.Audio=t})(e||(e={}));var e;(function(e){var t=function(t){function r(r,a,i,n,p){var s=t.call(this,r,a,i)||this;s.sprite=n,s.game=r,s.frame=p||0;var d=s.game.cache.image(n);if(s.width=d.frameWidth||10,s.height=d.frameHeight||10,s.columns=o(d.image.width/s.width),s.rows=o(d.image.height/s.height),s.tilled=!1,void 0!==s.game.cache.getJson(n)){s.json=s.game.cache.getJson(n);var l;l="string"==typeof s.frame?s.json[s.frame]:s.json.frames[s.frame],s.width=l.frame.w,s.height=l.frame.h}return(1<s.columns||1<s.rows||void 0!==s.json)&&(s.tilled=!0),s.position.setTo(a,i),s.shader=s.game.renderer.spriteBatch.shader,s.animation=new e.AnimationManager(r,s),s}var o=Math.floor;return n(r,t),r.prototype._beginRender=function(){},r.prototype._renderToCanvas=function(){if(this.tilled){var e=0,t=0,r=0,a=0,i=this.game.cache.image(this.sprite);if(this.json){var n="string"==typeof this.frame?this.json[this.frame]:this.json.frames[this.frame];var p=n.frame.w,s=n.frame.h;e=n.frame.x,t=n.frame.y,r=e+p,a=t+s}else{var d=this.frame;d>this.columns-1&&(d=this.frame%this.columns);var l=o(this.frame/this.columns);e=d*i.frameWidth,t=l*i.frameHeight,r=e+i.frameWidth,a=t+i.frameHeight}var u=e/i.image.width,m=t/i.image.height,c=r/i.image.width,g=a/i.image.height;this._uv=[u,m,u,g,c,m,c,g]}this.game.renderer.spriteBatch.addSprite(this,this.shader)},r.prototype.reset=function(t,r){this.position.x=t,this.position.y=r,this.alive=!0,void 0!==this.start&&this.start(),this.body&&(this.body.velocity=new e.Vector(0,0))},r.prototype._updateAnims=function(e){this.animation.update(e)},r}(e.GameObject);e.Sprite=t})(e||(e={}));var e;(function(e){var t=function(e){function t(t,r,o,a,i,n,p,s){var d=e.call(this,t,r,o,a,i)||this;d.frameIdle=i||a,d.frameDown=n||d.frameIdle,d.frameOver=p||d.frameIdle,d.frameUp=s||d.frameIdle,d.inputEnabled=!0;var l=d;return d.onInputDown.add(function(){l.swapSprite(l.frameDown)},d),d.onInputOver.add(function(){l.isInputDown||l.swapSprite(l.frameOver)},d),d.onInputLeft.add(function(){l.isInputDown||l.swapSprite(l.frameIdle)},d),d.onInputUp.add(function(){l.isInputOver?l.swapSprite(l.frameOver):l.swapSprite(l.frameUp)},d),d}return n(t,e),t.prototype.swapSprite=function(e){if(!this.tilled){this.sprite=e;var t=this.game.cache.image(this.sprite).image;this.width=t.width||10,this.height=t.height||10}else if(this.frame=e,void 0!==this.game.cache.getJson(e)){this.json=this.game.cache.getJson(e);var r;r="string"==typeof this.frame?this.json[this.frame]:this.json.frames[this.frame],this.width=r.frame.w,this.height=r.frame.h}},t}(e.Sprite);e.Button=t})(e||(e={}));var e;(function(e){var t=function(t){function r(r,o,a,i,n){var p=t.call(this,r,o,a)||this;return p.width=i,p.height=n,p.shader=p.game.resourceManager.createMaterial(e.CircleMat,"circleShader"),p}return n(r,t),r.prototype.getBounds=function(){var e=this.width*this.scale.x,t=this.height*this.scale.y;return{width:e,height:t}},r}(e.GameObject);e.Circle=t})(e||(e={}));var e;(function(e){var t=function(){function t(e){this.game=e}return t.prototype.existing=function(e,t,r){return void 0===t&&(t=!0),void 0===r&&(r=!1),t&&this.game.updateQueue.push(e),r&&this.game.renderQueue.push(e),e.parent=this.game,e._onInitialize(),void 0!==e.start&&e.start(),e},t.prototype.circle=function(t,r,o,a){var i=new e.Circle(this.game,t,r,o,a);return this.existing(i,!1,!0)},t.prototype.rect=function(t,r,o,a,i){var n=new e.Rect(this.game,t,r,o,a,i);return this.existing(n,!1,!0)},t.prototype.sprite=function(t,r,o,a){var i=new e.Sprite(this.game,t,r,o,a);return this.existing(i,!0,!0)},t.prototype.image=function(t,r,o,a){var i=new e.Sprite(this.game,t,r,o,a);return this.existing(i,!1,!0)},t.prototype.button=function(t,r,o,a,i,n,p){var s=new e.Button(this.game,t,r,o,a,i,n,p);return this.existing(s,!1,!0)},t.prototype.text=function(t,r,o,a){var i=new e.Text(this.game,t,r,o,a);return this.existing(i,!0,!0)},t.prototype.audio=function(t,r,o){var a=new e.Audio(this.game,t,r,o);return this.existing(a,!0,!1)},t.prototype.group=function(t,r){var o=new e.Group(this.game,t||0,r||0);return this.existing(o,!0,!0)},t}();e.ObjectFactory=t})(e||(e={}));var e;(function(e){var t=function(t){function r(e,r,o){var a=t.call(this,e,r,o)||this;return a.children=[],a}return n(r,t),r.prototype._beginRender=function(){},r.prototype.update=function(t){this.children.removePending();for(var r,o=this.children.length-1,a=o;0<=a;a--)r=this.children[a],r.alive&&(r.update(t),e.Sprite.prototype.isPrototypeOf(r)&&r._updateAnims(this.game.deltaMillis))},r.prototype.getFirstDead=function(){for(var e,t=this.children.length-1;0<=t;t--)if(e=this.children[t],!e.alive)return e;return null},r.prototype.getChildAtIndex=function(e){return this.children[e]},r.prototype.childCount=function(){return this.children.length},r.prototype.destroy=function(){this.kill(),this.isPendingDestroy=!0;for(var e,t=this.children.length-1;0<=t;t--)e=this.children[t],void 0!==e.destroy&&(e.destroy(),delete this.children[t]);this.children=[],void 0!==this.onDestroy&&this.onDestroy()},r.prototype.add=function(t){if(0<=this.game.updateQueue.indexOf(t)){var r=this.game.updateQueue.indexOf(t);this.game.updateQueue.splice(r,1)}if(0<=this.game.renderQueue.indexOf(t)){var r=this.game.renderQueue.indexOf(t);this.game.renderQueue.splice(r,1)}if(t.parent.constructor===e.Group&&0<=t.parent.indexOf(t)){var r=t.parent.children.indexOf(t);t.parent.children.splice(r,1)}return this.children.push(t),void 0!==t.start&&t.start(),t.parent=this,t},r.prototype.setAll=function(e,t){for(var r=this.children.length-1;0<=r;r--)this.children[r][e]=t},r.prototype.callAll=function(e){for(var t=this.children.length-1;0<=t;t--)void 0!==this.children[t][e]&&this.children[t][e]()},r}(e.GameObject);e.Group=t})(e||(e={}));var e;(function(e){var t=function(t){function r(r,o,a,i,n,p){var s=t.call(this,r,o,a)||this;return s.width=i,s.height=n,s.shader=s.game.resourceManager.createMaterial(e.SimpleColorMat,"colorShader"),s.setColor(p),s}return n(r,t),r.prototype._beginRender=function(){},r.prototype._renderToCanvas=function(){this.game.renderer.rectBatch.addRect(this,this.shader)},r}(e.GameObject);e.Rect=t})(e||(e={}));var e;(function(e){var t=function(t){function r(r,o,a,i,n){var p=t.call(this,r,o,a)||this;p.text=i||"",n=n||{},p.font=n.font||"Arial",p.size=n.font_size||12,p.textColor=n.font_color||"white",p.style="",p.strokeWidth=n.stroke_width||0,p.strokeColor=n.stroke_color||"black",p.canvas=document.createElement("canvas"),p.context=p.canvas.getContext("2d"),p.context.save(),p.context.font=p.size+"px "+p.font;var s=p.context.measureText(p.text);return p.context.restore(),p.width=s.width,p.height=p.size,p.shader=p.game.resourceManager.createMaterial(e.SimpleColorMat,"spriteShader"),p.updateText(),p}return n(r,t),r.prototype._beginRender=function(e){t.prototype._beginRender.call(this,e),this.shader._setTexture(this.texture),this.shader._beginRender(e)},r.prototype._renderToCanvas=function(e){null==this.shader||t.prototype._renderToCanvas.call(this,e)},r.prototype.setText=function(e){this.text=e,this.updateText()},r.prototype.getBounds=function(){var e=this.width*this.scale.x,t=this.height*this.scale.y;return{width:e,height:t}},r.prototype.updateText=function(){this.context.globalAlpha=this.alpha;var t=this.style+" "+this.size+"px "+this.font;this.context.font=t.trim();var r=this.context.measureText(this.text);this.width=r.width,this.height=0.8*this.size,this.canvas.width=r.width,this.canvas.height=this.height,this.context.font=t.trim(),0<this.strokeWidth&&(this.context.strokeStyle=this.strokeColor,this.context.lineWidth=this.strokeWidth,this.context.strokeText(this.text,0,this.height)),this.context.fillStyle=this.textColor,this.context.fillText(this.text,0,this.height);var o=new e.Texture2D("textTexture",this.width,this.height,e.WRAP_MODE.CLAMP);o.image=this.context.canvas,o.createTexture(this.game.context),this.texture=o._texture,this._setVertices(this.width,this.height,this.color,this._uv)},r}(e.GameObject);e.Text=t})(e||(e={}));var e;(function(e){var t;(function(e){e.NONE="none",e.HORIZONTAL="horizontal",e.VERTICAL="vertical",e.BOTH="both"})(t=e.AXIS||(e.AXIS={}));var r=function(){function t(t){this.game=t,this.position=new e.Vector(0,0),this.followedObject=null,this.axis=e.AXIS.BOTH,this.pMatrix=mat4.create()}return t.prototype.followObject=function(e,t,r){this.follow=!0,this.offsetLeft=t||0,this.offsetUp=r||0,this.followedObject=e},t.prototype.update=function(){null!=this.followedObject&&((this.axis===e.AXIS.BOTH||this.axis===e.AXIS.HORIZONTAL)&&0<this.followedObject.position.x-this.offsetLeft-this.game.width/2&&this.followedObject.position.x+this.offsetLeft+this.game.width/2<this.game.worldWidth&&(this.position.x=this.followedObject.position.x-this.game.width/2-this.offsetLeft),(this.axis===e.AXIS.BOTH||this.axis===e.AXIS.VERTICAL)&&0<this.followedObject.position.y-this.offsetUp-this.game.height/2&&this.followedObject.position.y+this.offsetUp+this.game.height/2<this.game.worldHeight&&(this.position.y=this.followedObject.position.y-this.game.height/2-this.offsetUp));var t=this.game.width+this.position.x,r=this.game.height+this.position.y;mat4.ortho(this.pMatrix,this.position.x,t,r,this.position.y,0.1,100)},t}();e.Camera=r})(e||(e={})),Array.prototype.removePending=function(){for(var e=this.length;e--;)this[e].isPendingDestroy&&(void 0!==this[e].body&&this[e].body.destroy(),delete this[e],this.splice(e,1))};var e;(function(e){e.version="2.0";var r=function(){function r(t,r,o){this.canvas=document.getElementById(o),this.canvas||(this.canvas=document.body.appendChild(document.createElement("canvas")),this.canvas.id=o),this.position=new e.Vector(0),this.width=t,this.height=r,this.worldWidth=t,this.worldHeight=r,this.canvas.setAttribute("widht",t.toString()),this.canvas.setAttribute("height",r.toString()),this.audioContext=new AudioContext,this.frameLimit=30,this._startTime=0,this._elapsedTime=0,this.frameTime=0,this.previousFrameTime=0,this.deltaTime=0,this.deltaMillis=0,this.pause=!1,this.isMobile=!1,this.ISO_TILE_WIDTH=32,this.ISO_TILE_HEIGHT=32,this.init()}return r.prototype.setBackgroundColor=function(e,t,r,o){this.renderer.setClearColor(e/255,t/255,r/255,o/255)},r.prototype.update=function(){var r=this;if((window.requestAnimationFrame?window.requestAnimationFrame(function(){r.update()}):(clearTimeout(this.timer),this.timer=setTimeout(function(){r.update()},this.frameLimit/1)),this.elapsedTime=Date.now()-this._startTime,this.frameTime=this.elapsedTime,this.deltaMillis=t(400,this.frameTime-this.previousFrameTime),this.deltaTime=this.deltaMillis/1e3,!(1/this.frameLimit>this.deltaTime))&&(this.previousFrameTime=this.frameTime,!this.pause)&&null!=this.state.currentState&&!this.load.preloading){this.updateQueue.removePending(),this.tween.update(this.deltaMillis);for(var o,a=this.updateQueue.length-1,n=a;0<=n;n--)o=this.updateQueue[n],o.alive&&(o.update(this.deltaTime),e.Sprite.prototype.isPrototypeOf(o)&&o._updateAnims(this.deltaMillis));this.state.currentState.update(this.deltaTime),this.camera.update(),this.renderQueue.removePending(),this.renderer.render()}},r.prototype.destroy=function(){for(var t,r=this.updateQueue.length-1;0<=r;r--){t=this.updateQueue[r],t.persist||(t.destroy(),void 0!==t.body&&t.body.destroy(),this.updateQueue.splice(r,1));var o=this.renderQueue.indexOf(t);-1!==o&&this.renderQueue.splice(o,1)}for(var t,r=this.renderQueue.length-1;0<=r;r--)t=this.renderQueue[r],t.persist||(t.destroy(),void 0!==t.body&&t.body.destroy(),this.renderQueue.splice(r,1));delete this.camera,this.camera=new e.Camera(this)},r.prototype.getWorldPos=function(){return this.position},r.prototype.getWorldMatrix=function(e){mat4.identity(e)},r.prototype.getTotalRotation=function(){return 0},r.prototype.init=function(){this._startTime=Date.now(),this._elapsedTime=0,this.frameTime=0,this.previousFrameTime=0,this.deltaTime=0,this.deltaMillis=0,this.updateQueue=[],this.renderQueue=[],this.pause=!1,this.state=new e.StateManager(this),this.add=new e.ObjectFactory(this),this.tween=new e.TweenManager(this),this.cache=new e.Cache(this),this.load=new e.Loader(this),this.camera=new e.Camera(this),this.renderer=new e.Renderer(this,this.canvas),this.context=this.renderer.context,this.resourceManager=new e.ResourceManager(this.context),this.renderer.init(),this.scale=new e.ScaleManager(this),this.scale.init(),this.isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),this.input=new e.InputManager(this),console.log("Game engine "+e.version+" arrancado con webgl!!!"),this.update()},r}();e.Game=r})(e||(e={}));var e;(function(e){var n=function(){function r(){}return r.randomRange=function(e,t){return e+Math.random()*(t-e)},r.randomIntRange=function(e,t){return i(e+Math.random()*(t-e))},r.clamp=function(e,r,o){return Math.max(t(e,o),r)},r.lerp=function(r,o,a){return a=e.Mathf.clamp(a,0,1),(1-a)*r+a*o},r.lerpColor=function(e,t,r){var o=parseInt(e.replace(/#/g,""),16),a=o>>16,i=255&o>>8,n=255&o,p=parseInt(t.replace(/#/g,""),16);return"#"+(0|16777216+(a+r*((p>>16)-a)<<16)+(i+r*((255&p>>8)-i)<<8)+(n+r*((255&p)-n))).toString(16).slice(1)},r.angleBetween=function(e,t,r,o){return Math.atan2(o-t,r-e)},r.TO_RADIANS=0.017453292519943295,r.TO_DEGREES=57.29577951308232,r}();e.Mathf=n;var p=function(){function t(e,t,r){void 0===t&&(t=e),void 0===r&&(r=1),this.zOffset=0,this.x=e,this.y=t,this.z=r,this.zOffset=0}return t.prototype.setTo=function(e,t){void 0===t&&(t=e),this.x=e,this.y=t},t.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.prototype.multiply=function(e){return this.x*=e.x,this.y*=e.y,this},t.prototype.multiplyMatrix=function(e){var t=this.x,r=this.y,o=[,,,];return this.x=t*e[0]+r*e[4]+e[8]+e[12],this.y=t*e[1]+r*e[5]+e[9]+e[13],this},t.prototype.rotate=function(e){var t=this.x,r=this.y;return this.x=t*a(e)-r*o(e),this.y=t*o(e)+r*a(e),this},t.prototype.normalize=function(){var e=this.length();return 0<e&&(this.x/=e,this.y/=e),this},t.prototype.project=function(e){var t=this.dot(e)/e.len2();return this.x=t*e.x,this.y=t*e.y,this},t.prototype.scale=function(e,t){return void 0===t&&(t=e),this.x*=e,this.y*=t,this},t.prototype.reflect=function(e){var t=this.x,r=this.y;return this.project(e).scale(2),this.x-=t,this.y-=r,this},t.prototype.distance=function(t){var r=new e.Vector(this.x,this.y,this.z);return r.sub(t),r.length()},t.prototype.len2=function(){return this.dot(this)},t.prototype.length=function(){return r(this.len2())},t.prototype.dot=function(e){return this.x*e.x+this.y*e.y},t.Zero=new t(0),t}();e.Vector=p})(e||(e={}));var e;(function(e){var t;(function(e){e[e.FIT=0]="FIT",e[e.SHOW_ALL=1]="SHOW_ALL",e[e.NO_SCALE=2]="NO_SCALE"})(t=e.Scale||(e.Scale={}));var r=function(){function r(e){this.game=e,this.scaleType=t.NO_SCALE,this.orientation="landScape",this.sourceAspectRatio=0}return r.prototype.init=function(){var e=this;window.addEventListener("resize",function(t){e.onWindowsResize(t)},!0)},r.prototype.updateScale=function(){if(this.scaleType!==e.Scale.NO_SCALE){var t=0,r=0;this.scaleType===e.Scale.FIT?(t=window.innerWidth,r=window.innerHeight):(this.sourceAspectRatio=this.game.width/this.game.height,r=window.innerHeight,t=r*this.sourceAspectRatio,t>window.innerWidth&&(t=window.innerWidth,r=t/this.sourceAspectRatio)),t=i(t),r=i(r),this.resizeCanvas(t,r)}},r.prototype.resizeCanvas=function(e,t){this.game.canvas.setAttribute("width",e),this.game.canvas.setAttribute("height",t),this.game.renderer.setScale(e/this.game.width,t/this.game.height),this.game.context.viewport(0,0,e,t)},r.prototype.onWindowsResize=function(){this.updateScale()},r}();e.ScaleManager=r})(e||(e={}));var e;(function(e){var t=function(){function e(e){this.game=e,this.states=[],this.currentState=null,this.currentStateName=null}return e.prototype.add=function(e,t){this.states[e]=t},e.prototype.start=function(e){var t=this;null!=t.currentState&&(t.game.destroy(),void 0!==t.currentState.destroy&&t.currentState.destroy(),delete t.currentState,t.currentState=null);var r=t.states[e];return null==r?void console.error("no state for name "+e):void(t.currentState=new r(t.game),void 0===t.currentState.update&&(t.currentState.update=function(){}),t.currentState.game=t.game,t.currentState.stateName=e,void 0!==t.currentState.preload&&t.currentState.preload(),t.game.scale.updateScale(),t.game.load._startPreload())},e.prototype.restart=function(){this.start(this.currentState.stateName)},e}();e.StateManager=t})(e||(e={}));var e;(function(e){var t=function(){function t(t,r){this.game=t,this.clearColor={r:0,g:0,b:0,a:0},this.scale=new e.Vector(1);this.context=r.getContext("webgl2",{stencil:!0,antialias:!1})}return t.prototype.init=function(){this.context?(this.context.clearColor(this.clearColor.r,this.clearColor.g,this.clearColor.b,this.clearColor.a),this.context.clear(this.context.COLOR_BUFFER_BIT),this.context.blendFunc(this.context.ONE,this.context.ONE_MINUS_SRC_ALPHA),this.context.disable(this.context.DEPTH_TEST),this.context.enable(this.context.BLEND),this.context.viewport(0,0,+this.game.canvas.getAttribute("width"),+this.game.canvas.getAttribute("height")),this.resourceManager=this.game.resourceManager,this.spriteBatch=new e.SpriteBatcher.SpriteBatch(this.game,this.context,this),this.rectBatch=new e.RectBatcher.RectBatch(this.game,this.context,this),this.renderer=null,this.sprite=void 0):(alert("Imposible inicializar WebGL. Tu navegador puede no soportarlo."),this.context=null)},t.prototype.render=function(){this.context.clear(this.context.COLOR_BUFFER_BIT),this.context.viewport(0,0,this.game.canvas.width,this.game.canvas.height),this.renderLoop(this.game.renderQueue),this.renderer&&(this.renderer.flush(),this.renderer=null,this.sprite=null)},t.prototype.setRenderer=function(e,t){(this.renderer!==e||this.sprite!==t)&&this.renderer&&this.renderer.flush(),e&&e.shouldFlush()&&e.flush(),this.renderer=e,this.sprite=t},t.prototype.setClearColor=function(e,t,r,o){this.clearColor.r=e,this.clearColor.g=t,this.clearColor.b=r,this.clearColor.a=o,this.context.clearColor(this.clearColor.r,this.clearColor.g,this.clearColor.b,this.clearColor.a)},t.prototype.renderLoop=function(t){for(var r,o=this,a=t.length,n=0;n<a;n++)if(r=t[n],!!r.render)if(e.Group.prototype.isPrototypeOf(r))r._beginRender(o.context),o.renderLoop(r.children),r._endRender(o.context);else if(!e.Audio.prototype.isPrototypeOf(r)){if(!r.alive)continue;if(this.game.autoCulling&&!r.isInsideCamera())continue;r._beginRender(o.context),r._renderToCanvas(o.context),void 0!==r.body&&r.body._renderBounds(o.context),r._endRender(o.context)}},t.prototype.setScale=function(e,t){this.scale.x=e,this.scale.y=t||e},t}();e.Renderer=t})(e||(e={}));var e;(function(e){var t;(function(t){var i=function(){function e(){}return e.None=function(e){return e},e}();t.Linear=i;var n=function(){function e(){}return e.In=function(e){return e*e},e.Out=function(e){return e*(2-e)},e.InOut=function(e){return .5>e?2*e*e:-1+(4-2*e)*e},e}();t.Quad=n;var p=function(){function e(){}return e.In=function(e){return e*e*e},e.Out=function(e){return--e*e*e+1},e.InOut=function(e){return .5>e?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1},e}();t.Cubic=p;var s=function(){function e(){}return e.In=function(e){return e*e*e*e},e.Out=function(e){return 1- --e*e*e*e},e.InOut=function(e){return .5>e?8*e*e*e*e:1-8*--e*e*e*e},e}();t.Quart=s;var d=function(){function e(){}return e.In=function(e){return e*e*e*e*e},e.Out=function(e){return 1+--e*e*e*e*e},e.InOut=function(e){return .5>e?16*e*e*e*e*e:1+16*--e*e*e*e*e},e}();t.Quint=d;var l=function(){function e(){}var r=Math.PI;return e.In=function(e){return 0===e?0:1===e?1:a(e*r/2)},e.Out=function(e){return 0===e?0:1===e?1:o(e*r/2)},e.InOut=function(e){return 0===e?0:1===e?1:0.5*(1-a(r*e))},e}();t.Sin=l;var u=function(){function e(){}var r=Math.pow;return e.In=function(e){return 0===e?0:r(1024,e-1)},e.Out=function(e){return 1===e?1:1-r(2,-10*e)},e.InOut=function(e){return 0===e?0:1===e?1:1>(e*=2)?0.5*r(1024,e-1):0.5*(-r(2,-10*(e-1))+2)},e}();t.Expo=u;var m=function(){function e(){}return e.In=function(e){return 1-r(1-e*e)},e.Out=function(e){return r(1- --e*e)},e.InOut=function(e){return 1>(e*=2)?-0.5*(r(1-e*e)-1):0.5*(r(1-(e-=2)*e)+1)},e}();t.Circular=m;var c=function(){function e(){}return e.In=function(e){var t=1.70158;return e*e*((t+1)*e-t)},e.Out=function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},e.InOut=function(e){var t=1.525*1.70158;return 1>(e*=2)?0.5*(e*e*((t+1)*e-t)):0.5*((e-=2)*e*((t+1)*e+t)+2)},e}();t.Back=c;var g=function(){function r(){}return r.In=function(e){return 1-r.Out(1-e)},r.Out=function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+0.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+0.9375:7.5625*(e-=2.625/2.75)*e+0.984375},r.InOut=function(r){return 0.5>r?0.5*e.Easing.Bounce.In(2*r):0.5*e.Easing.Bounce.Out(2*r-1)+0.5},r}();t.Bounce=g})(t=e.Easing||(e.Easing={}))})(e||(e={}));var e;(function(e){var t=function(){function t(t){this.started=!1,this.isPendingDestroy=!1,this.started=!1,this.target=t,this.fromProperties=[],this.properties=[],this.duration=0,this.autoStart=!0,this.easing=void 0,this.delay=0,this.repeat=0,this.runCount=0,this.isRunning=!1,this.progress=0,this.time=0,this.yoyo=!1,this.onComplete=new e.Signal,this.onCompleteLoop=new e.Signal}return t.prototype.play=function(){this.started=!0;var e=setTimeout(function(){clearTimeout(e),this.startTween()},this.delay)},t.prototype.to=function(e,t,r,o,a,i,n){for(var p in e)this.fromProperties[p]=this.target[p];return this.properties=e,this.duration=t,this.easing=r,this.autoStart=o||!0,this.delay=a||0,this.repeat=i||0,this.yoyo=n||!1,this},t.prototype.from=function(e){for(var t in e)this.fromProperties[t]=e[t];return this},t.prototype.complete=function(){for(var e in this.time=this.duration,this.properties)this.target[e]=this.fromProperties[e]},t.prototype.update=function(r){if(void 0===this.target||null==this.target)return void this.destroy();if(1===this.progress)return void(-1===this.repeat||this.runCount<=this.repeat?(this.onCompleteLoop.dispatch(),this.time=0,this.progress=0,this.play()):(this.onComplete.dispatch(),this.destroy()));for(var o in this.progress=e.Mathf.clamp(this.time/this.duration,0,1),this.properties){var a=this.progress;if(this.yoyo)if(0.5>=a)a*=2;else{var t=2*(a-0.5);a=e.Mathf.lerp(1,0,t)}this.target[o]=e.Mathf.lerp(this.fromProperties[o],this.properties[o],this.easing(a))}this.time+=r},t.prototype.destroy=function(){this.isRunning=!1,this.isPendingDestroy=!0,void 0!==this.onComplete&&this.onComplete._destroy(),void 0!==this.onCompleteLoop&&this.onCompleteLoop._destroy(),delete this.onComplete,delete this.onCompleteLoop,delete this.fromProperties,delete this.properties},t.prototype.startTween=function(){for(var e in this.runCount++,this.properties)this.target[e]=this.fromProperties[e];this.isRunning=!0},t}();e.Tween=t})(e||(e={}));var e;(function(e){var t=function(){function t(e){this.game=e,this.tweens=[]}return t.prototype.add=function(t){var r=new e.Tween(t);return this.tweens.push(r),r},t.prototype.update=function(e){for(var t,r=0;r<this.tweens.length;r++)t=this.tweens[r],t.isPendingDestroy?(delete this.tweens[r],this.tweens.splice(r,1),r--):t.isRunning?t.update(e):t.autoStart&&!t.started&&t.play()},t.prototype.destroy=function(){for(var e=this.tweens.length-1;0<=e;e--)this.tweens[e].destroy(),delete this.tweens[e];delete this.tweens,this.tweens=[]},t}();e.TweenManager=t})(e||(e={}));var e;(function(e){var t=function(){function t(){this.bindings=[]}return t.prototype.add=function(t,r){var o=new e.SignalBinding(this,t,r,!1);return this.bindings.push(o),o},t.prototype.addOnce=function(t,r){var o=new e.SignalBinding(this,t,r,!0);return this.bindings.push(o),o},t.prototype.remove=function(e){for(var t=0;t<this.bindings.length;t++)this.bindings[t].listenerContext===e&&this.bindings.splice(t,1)},t.prototype._destroy=function(){delete this.bindings,this.bindings=[]},t.prototype.dispatch=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._cleanup();for(var r=0;r<this.bindings.length;r++)this.bindings[r].dispatch.apply(this.bindings[r],arguments)},t.prototype._cleanup=function(){for(var e=this.bindings.length-1;0<=e;e--)(null==this.bindings[e]||void 0===this.bindings[e])&&this.bindings.splice(e,1)},t}();e.Signal=t})(e||(e={}));var e;(function(e){var t=function(){function e(e,t,r,o){this.isOnce=!1,this.signal=e,this.listener=t,this.listenerContext=r,this.isOnce=o}return e.prototype.dispatch=function(){this.listener.apply(this.listenerContext,arguments),this.isOnce&&this.detach()},e.prototype.detach=function(){this.signal.remove(this.listenerContext)},e}();e.SignalBinding=t})(e||(e={}));var e;(function(e){var t=function(){function e(e,t,r){this.audioName=e,this.audioUrl=t,this.completed=!1,this.loader=r}return e.prototype.load=function(){var e=this,t={audioName:e.audioName,audio:null,decoded:!1},r=new XMLHttpRequest;r.open("GET",e.audioUrl,!0),r.responseType="arraybuffer";r.onload=function(){var t=e.loader.game.cache.audios[e.audioName];200===r.status?e.loader.game.audioContext.decodeAudioData(r.response,function(r){t.audio=r,t.decoded=!0,e.completed=!0,e.loader._notifyCompleted()},function(){e.completed=!0,e.loader._notifyCompleted()}):(e.completed=!0,e.loader._notifyCompleted())},e.loader.game.cache.audios[e.audioName]=t,r.send()},e}();e.AudioLoader=t})(e||(e={}));var e;(function(e){var t=function(){function e(e){this.game=e,this.images=[],this.audios=[],this.json=[]}return e.prototype.image=function(e){return void 0===this.images[e]?void console.error("No hay imagen para el nombre: "+e):this.images[e]},e.prototype.audio=function(e){return void 0===this.audios[e]?void console.error("No hay audio para el nombre: "+e):this.audios[e]},e.prototype.getJson=function(e){return this.json[e]},e.prototype.clearCache=function(){delete this.images,delete this.audios,delete this.json,this.images=[],this.audios=[],this.json=[]},e}();e.Cache=t})(e||(e={}));var e;(function(e){var t=function(){function t(e,t,r,o,a){void 0===o&&(o=0),void 0===a&&(a=0),this.imageName=e,this.imageUrl=t,this.completed=!1,this.loader=r,this.frameWidth=o,this.frameHeight=a}return t.prototype.load=function(){var t=this,r=new e.Texture2D(t.imageName,t.frameWidth,t.frameHeight,1),o=new Image,a=function(){var o=t.loader.game.cache.images[t.imageName];o.image=this,t.completed=!0,0===t.frameWidth?(o.frameWidth=this.width,r.wrapMode=e.WRAP_MODE.CLAMP):o.frameWidth=t.frameWidth,0===t.frameHeight?(o.frameHeight=this.height,r.wrapMode=e.WRAP_MODE.CLAMP):o.frameHeight=t.frameHeight,o.createTexture(t.loader.game.context),t.loader._notifyCompleted()};o.onload=a,o.onerror=a,o.src=t.imageUrl,t.loader.game.cache.images[r.imageName]=r},t}();e.ImageLoader=t})(e||(e={}));var e;(function(e){var t=function(){function e(e,t,r,o){this.imageName=e,this.imageUrl=t,this.jsonUrl=r,this.completed=!1,this.loader=o,this.frameWidth=0,this.frameHeight=0,this.oneCompleted=!1,this.loader.image(this.imageName,this.imageUrl)}return e.prototype.load=function(){this.loadJson()},e.prototype.loadJson=function(){var e=this,t=new XMLHttpRequest;t.open("GET",e.jsonUrl,!0);t.onload=function(){if(200===t.status){for(var r,o=JSON.parse(t.responseText),a=o,n=0;n<a.frames.length;n++)r=a.frames[n],a[r.filename]=r;e.loader.game.cache.json[e.imageName]=a}e.completed=!0,e.loader._notifyCompleted()},t.send()},e}();e.JsonImageLoader=t})(e||(e={}));var e;(function(e){var t=function(){function t(t){this.game=t,this.pendingLoads=[],this.progress=0,this.preloading=!1,this.onCompleteFile=new e.Signal}return t.prototype.image=function(t,r){this.pendingLoads.push(new e.ImageLoader(t,r,this))},t.prototype.spriteSheet=function(t,r,o,a){this.pendingLoads.push(new e.ImageLoader(t,r,this,o,a))},t.prototype.jsonSpriteSheet=function(t,r,o){this.pendingLoads.push(new e.JsonImageLoader(t,r,o,this))},t.prototype.audio=function(t,r){this.pendingLoads.push(new e.AudioLoader(t,r,this))},t.prototype._startPreload=function(){if(this.preloading=!0,0===this.pendingLoads.length)this._callStart();else for(var e=0;e<this.pendingLoads.length;e++)this.pendingLoads[e].load()},t.prototype._notifyCompleted=function(){for(var e=0,t=0;t<this.pendingLoads.length;t++)this.pendingLoads[t].completed&&e++;this.progress=e/this.pendingLoads.length,this.onCompleteFile.dispatch(this.progress),1===this.progress&&(delete this.pendingLoads,this.onCompleteFile._destroy(),this.pendingLoads=[],this._callStart())},t.prototype._callStart=function(){this.preloading=!1,this.game.state.currentState.start()},t}();e.Loader=t})(e||(e={}));var e;(function(e){var t;(function(e){e[e.FLOAT=0]="FLOAT",e[e.INTEGER=1]="INTEGER",e[e.MAT2X2=2]="MAT2X2",e[e.MAT3X3=3]="MAT3X3",e[e.MAT4X4=4]="MAT4X4",e[e.VECTOR2=5]="VECTOR2",e[e.VECTOR3=6]="VECTOR3",e[e.VECTOR4=7]="VECTOR4",e[e.SAMPLER=8]="SAMPLER"})(t=e.Uniforms||(e.Uniforms={}));var r=function(){function e(){}return e.compileVertexShader=function(e){return e=e.replace("#XBaseParams",this.vertexBaseParams.join("\n")),e+=this.vertexMain.join("\n"),e},e.compileFragmentShader=function(e){return e=e.replace("#XBaseParams",this.fragmentBaseParams.join("\n")),e},e.vertexBaseParams=["in vec2 aVertexPosition;","in vec2 vUv;","in vec3 aVertexColor;","in float in_alpha;","uniform mat4 pMatrix;","out highp vec2 uv;","vec4 vertPos;","out lowp vec3 vColor;","out lowp float alpha;"],e.fragmentBaseParams=["in lowp vec3 vColor;","in highp vec2 uv;","in float alpha;","out vec4 fragColor;"],e.vertexMain=["void main(void) {","vertPos = pMatrix * vec4(aVertexPosition, -1.0, 1.0);","uv = vUv;","vColor = aVertexColor;","alpha = in_alpha;","mainPass();","gl_Position = vertPos;","}"],e}();e.ShaderCompiler=r})(e||(e={}));var e;(function(e){e.ShaderUniforms={pMatrix:{value:null,type:e.Uniforms.MAT4X4}};var t=function(){function t(t,r,o){void 0===o&&(o={}),this.uniforms=o,this.baseUniforms=JSON.parse(JSON.stringify(e.ShaderUniforms)),this.vertColAtt=null,this.vertColAtt=null,this.shaderProgram=null,this.compiled=!1,this.vertexCode=t,this.fragmentCode=r}return t.prototype.initializeShader=function(t){for(var r="",o="",a=0;a<this.vertexCode.length;a++)r+=this.vertexCode[a]+"\n";r=e.ShaderCompiler.compileVertexShader(r);for(var i=0;i<this.fragmentCode.length;i++)o+=this.fragmentCode[i]+"\n";o=e.ShaderCompiler.compileFragmentShader(o);var n,p;return p=t.createShader(t.FRAGMENT_SHADER),n=t.createShader(t.VERTEX_SHADER),t.shaderSource(n,r),t.compileShader(n),t.shaderSource(p,o),t.compileShader(p),t.getShaderParameter(n,t.COMPILE_STATUS)?t.getShaderParameter(p,t.COMPILE_STATUS)?void(this.shaderProgram=t.createProgram(),t.attachShader(this.shaderProgram,n),t.attachShader(this.shaderProgram,p),t.linkProgram(this.shaderProgram),!t.getProgramParameter(this.shaderProgram,t.LINK_STATUS)&&(alert("Could not initialise shaders"),this.compiled=!0),this.compiled=!0,this.setUniforms(t)):(alert(t.getShaderInfoLog(p)),this.compiled=!0,null):(alert(t.getShaderInfoLog(n)),this.compiled=!0,null)},t.prototype.setUniforms=function(e){for(var t in e.useProgram(this.shaderProgram),this.vertPosAtt=e.getAttribLocation(this.shaderProgram,"aVertexPosition"),this.vertColAtt=e.getAttribLocation(this.shaderProgram,"aVertexColor"),this.vertUvAtt=e.getAttribLocation(this.shaderProgram,"vUv"),this.vertAlphaAtt=e.getAttribLocation(this.shaderProgram,"in_alpha"),this.uniforms)this.uniforms.hasOwnProperty(t)&&(this.uniforms[t].gpuPosition=e.getUniformLocation(this.shaderProgram,t));for(var t in this.baseUniforms)this.baseUniforms.hasOwnProperty(t)&&(this.baseUniforms[t].gpuPosition=e.getUniformLocation(this.shaderProgram,t))},t.prototype.getAttribLocation=function(e,t){return e.getAttribLocation(this.shaderProgram,t)},t.prototype._beginRender=function(e){this.compiled||this.initializeShader(e),e.useProgram(this.shaderProgram)},t.prototype.bind=function(e){this.compiled||this.initializeShader(e),e.useProgram(this.shaderProgram)},t.prototype._setUniform=function(t,r){var o=t.type;o===e.Uniforms.INTEGER?r.uniform1i(t.gpuPosition,t.value):o===e.Uniforms.FLOAT?r.uniform1f(t.gpuPosition,t.value):o===e.Uniforms.VECTOR2?r.uniform2fv(t.gpuPosition,t.value):o===e.Uniforms.VECTOR3?r.uniform3fv(t.gpuPosition,t.value):o===e.Uniforms.VECTOR4?r.uniform4fv(t.gpuPosition,t.value):o===e.Uniforms.MAT2X2?r.uniformMatrix2fv(t.gpuPosition,!1,t.value):o===e.Uniforms.MAT3X3?r.uniformMatrix3fv(t.gpuPosition,!1,t.value):o===e.Uniforms.MAT4X4?r.uniformMatrix4fv(t.gpuPosition,!1,t.value):r.uniform1f(t.gpuPosition,t.value)},t.prototype.updateUniforms=function(e){for(var t in this.uniforms)this.uniforms.hasOwnProperty(t)&&(this._setUniform(this.uniforms[t],e),this.uniforms[t].prevVal=this.uniforms[t].value);for(var t in this.baseUniforms)this.baseUniforms.hasOwnProperty(t)&&(this._setUniform(this.baseUniforms[t],e),this.baseUniforms[t].prevVal=this.baseUniforms[t].value)},t}();e.Material=t})(e||(e={}));var e;(function(e){var t;(function(e){var t=function(){return function(){}}();e.MaterialLibObject=t;var r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.vertexShader=["#version 300 es","#XBaseParams","void mainPass() {","}"],t.fragmentShader=["#version 300 es","precision mediump float;","uniform sampler2D texSampler;","#XBaseParams","void main(void) {","vec4 texCol = texture(texSampler, uv);","texCol.rgb *= texCol.w;","texCol.xyz *= vColor;","fragColor = texCol*alpha;","}"],t}(t);e.Sprite=r;var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.vertexShader=["#version 300 es","#XBaseParams","void mainPass() {","}"],t.fragmentShader=["#version 300 es","precision mediump float;","#XBaseParams","void main(void) {","fragColor = vec4(vColor, alpha) * alpha;","}"],t}(t);e.SimpleColor=o;var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.vertexShader=["#version 300 es","#XBaseParams","void mainPass() {","}"],t.fragmentShader=["#version 300 es","precision mediump float;","#XBaseParams","void main(void) {","vec2 uvOffset = uv - 0.5;","float distance = length(uvOffset);","float res = smoothstep(distance,distance+0.04,0.5);","if(res < 0.1) discard;","fragColor = vec4(1.0, 1.0, 1.0, res) * res * alpha;","fragColor.xyz *= vColor;","}"],t}(t);e.CircleColor=a})(t=e.MaterialLib||(e.MaterialLib={}))})(e||(e={}));var e;(function(e){var t=function(t){function r(){return t.call(this,e.MaterialLib.CircleColor.vertexShader,e.MaterialLib.CircleColor.fragmentShader)||this}return n(r,t),r.shader=new r,r}(e.Material);e.CircleMat=t})(e||(e={}));var e;(function(e){var t=function(t){function r(){return t.call(this,e.MaterialLib.SimpleColor.vertexShader,e.MaterialLib.SimpleColor.fragmentShader)||this}return n(r,t),r.shader=new r,r}(e.Material);e.SimpleColorMat=t})(e||(e={}));var e;(function(e){var t=function(t){function r(){return t.call(this,e.MaterialLib.Sprite.vertexShader,e.MaterialLib.Sprite.fragmentShader)||this}return n(r,t),r.prototype._setTexture=function(e){this.texture=e},r.prototype._beginRender=function(t){e.Material.prototype._beginRender.call(this,t),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture)},r.shader=new r,r}(e.Material);e.SpriteMat=t})(e||(e={}));var e;(function(e){var t=function(){function e(e){this.wordLength=0,this.wordCapacity=e/4,this.buffer=new ArrayBuffer(e),this.intView=new Int16Array(this.buffer),this.uintView=new Uint16Array(this.buffer)}return e.prototype.clear=function(){this.wordLength=0},e.prototype.getByteLength=function(){return 4*this.wordLength},e.prototype.getByteCapacity=function(){return this.buffer.byteLength},e.prototype.allocate=function(e){var t=this.wordLength;return this.wordLength+=e,t},e.prototype.getUsedBufferAsInt=function(){return this.intView.subarray(0,this.wordLength)},e.prototype.getUsedBufferAsUint=function(){return this.uintView.subarray(0,this.wordLength)},e}();e.DataBuffer16=t})(e||(e={}));var e;(function(e){var t=function(){function e(e){this.wordLength=0,this.wordCapacity=e/4,this.buffer=new ArrayBuffer(e),this.floatView=new Float32Array(this.buffer),this.intView=new Int32Array(this.buffer),this.uintView=new Uint32Array(this.buffer)}return e.prototype.clear=function(){this.wordLength=0},e.prototype.getByteLength=function(){return 4*this.wordLength},e.prototype.getByteCapacity=function(){return this.buffer.byteLength},e.prototype.allocate=function(e){var t=this.wordLength;return this.wordLength+=e,t},e.prototype.getUsedBufferAsFloat=function(){return this.floatView.subarray(0,this.wordLength)},e.prototype.getUsedBufferAsInt=function(){return this.intView.subarray(0,this.wordLength)},e.prototype.getUsedBufferAsUint=function(){return this.uintView.subarray(0,this.wordLength)},e}();e.DataBuffer32=t})(e||(e={}));var e;(function(e){var t=function(){function e(e,t){this.gl=e,this.bufferType=e.ELEMENT_ARRAY_BUFFER,this.buffer=t}return e.SetDiry=function(){e.CurrentIndexBuffer=null},e.prototype.updateResource=function(t,r){var o=this.gl;e.CurrentIndexBuffer=this,o.bindBuffer(this.bufferType,this.buffer),o.bufferSubData(this.bufferType,r,t)},e.prototype.bind=function(){var t=this.gl,r=this.buffer;e.CurrentIndexBuffer=this,t.bindBuffer(this.bufferType,r)},e}();e.IndexBuffer=t})(e||(e={}));var e;(function(e){var t=function(){function t(e){this.gl=e,this.shaderCache=[]}return t.prototype.createBuffer=function(t,r,o){var a=this.gl,i=a.createBuffer();return a.bindBuffer(t,i),a.bufferData(t,r,o),t===a.ARRAY_BUFFER?new e.VertexBuffer(a,i):t===a.ELEMENT_ARRAY_BUFFER?new e.IndexBuffer(a,i):void 0},t.prototype.createMaterial=function(e,t){var r;return void 0===t?(r=new e,r.initializeShader(this.gl)):this.shaderCache[t]?r=this.shaderCache[t]:(r=new e,r.initializeShader(this.gl),this.shaderCache[t]=r),r},t}();e.ResourceManager=t})(e||(e={}));var e;(function(e){var t;(function(e){e[e.CLAMP=0]="CLAMP",e[e.WRAP=1]="WRAP"})(t=e.WRAP_MODE||(e.WRAP_MODE={}));var r=function(){function e(e,r,o,a){void 0===a&&(a=t.CLAMP),this.imageName=e,this.frameWidth=r,this.frameHeight=o,this._texture=null,this.ready=!1,this.wrapMode=a}return e.prototype.createTexture=function(e){if(null!=this.imageName){this._texture=e.createTexture();var r=e.RGBA,o=e.RGBA,a=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,this._texture),this.wrapMode===t.WRAP?(e.texImage2D(e.TEXTURE_2D,0,r,o,a,this.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)):(e.texImage2D(e.TEXTURE_2D,0,r,o,a,this.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this.ready=!0}},e}();e.Texture2D=r})(e||(e={}));var e;(function(e){var t=function(){function e(e,t){this.gl=e,this.bufferType=e.ARRAY_BUFFER,this.buffer=t,this.attributes=[]}return e.SetDiry=function(){e.CurrentVertexBuffer=null},e.prototype.addAttribute=function(e,t,r,o,a,i){this.attributes.push({index:e,size:t,type:r,normalized:o,stride:a,offset:i})},e.prototype.updateResource=function(t,r){var o=this.gl;e.CurrentVertexBuffer=this,o.bindBuffer(this.bufferType,this.buffer),o.bufferSubData(this.bufferType,r,t)},e.prototype.bind=function(){var t=this.gl,r=this.buffer,o=this.attributes,a=o.length;e.CurrentVertexBuffer=this,t.bindBuffer(t.ARRAY_BUFFER,r);for(var i,n=0;n<a;++n)i=o[n],void 0!==i&&null!==i&&(t.enableVertexAttribArray(i.index),t.vertexAttribPointer(i.index,i.size,i.type,i.normalized,i.stride,i.offset))},e}();e.VertexBuffer=t})(e||(e={}));var e;(function(e){var t;(function(e){var t=function(){function e(){}return e.VERTEX_SIZE=24,e.INDEX_SIZE=2,e.VERTEX_COUNT=4,e.INDEX_COUNT=6,e.VERTEX_COMPONENT_COUNT=6,e.MAX_RECTS=2e3,e}();e.Consts=t})(t=e.RectBatcher||(e.RectBatcher={}))})(e||(e={}));var e;(function(e){var t;(function(t){var r=function(){function r(e,t,r){this.gl=t,this.game=e,this.renderer=r,this.maxSprites=null,this.shader=null,this.vertexBufferObject=null,this.indexBufferObject=null,this.vertexDataBuffer=null,this.indexDataBuffer=null,this.elementCount=0,this.mask=null,this.vertexCount=0,this.init(this.gl)}return r.prototype.shouldFlush=function(){return!!this.isFull()},r.prototype.isFull=function(){return this.vertexDataBuffer.getByteLength()>=this.vertexDataBuffer.getByteCapacity()},r.prototype.bind=function(e){e?(e.bind(this.gl),e.baseUniforms.pMatrix.value=this.game.camera.pMatrix,e.updateUniforms(this.gl)):(this.shader.bind(this.gl),this.shader.baseUniforms.pMatrix.value=this.game.camera.pMatrix,this.shader.updateUniforms(this.gl)),this.vertexBufferObject.bind(),this.indexBufferObject.bind()},r.prototype.flush=function(e){var t=this.gl;this.mask&&this.mask.rendermask(t);var r=this.vertexDataBuffer;0===this.elementCount&&0===this.vertexCount||(this.bind(e),this.vertexBufferObject.updateResource(r.floatView,0),t.drawElements(t.TRIANGLES,this.elementCount,t.UNSIGNED_SHORT,0),r.clear(),this.elementCount=0,this.vertexCount=0,this.mask&&(this.mask.endRendermask(t),this.mask=null))},r.prototype.addRect=function(t,r){(t.mask!==this.mask||this.shader!==r)&&(this.flush(this.shader),this.shader=r),t.mask&&(this.mask=t.mask),this.renderer.setRenderer(this,null);var o=this.vertexDataBuffer.floatView,a=this.vertexDataBuffer.uintView,i=this.vertexDataBuffer.allocate(24),n=new e.Vector(0,0);mat4.identity(t.mvMatrix),t.getWorldMatrix(t.mvMatrix),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[0],o[i++]=t._uv[1],a[i++]=t.color,o[i++]=t.alpha,n.setTo(0,t.height),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[2],o[i++]=t._uv[3],a[i++]=t.color,o[i++]=t.alpha,n.setTo(t.width,0),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[4],o[i++]=t._uv[5],a[i++]=t.color,o[i++]=t.alpha,n.setTo(t.width,t.height),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[6],o[i++]=t._uv[7],a[i++]=t.color,o[i++]=t.alpha,this.elementCount+=6},r.prototype.init=function(r){var o=new e.DataBuffer32(t.Consts.VERTEX_SIZE*t.Consts.VERTEX_COUNT*t.Consts.MAX_RECTS),a=new e.DataBuffer16(t.Consts.INDEX_SIZE*t.Consts.INDEX_COUNT*t.Consts.MAX_RECTS),i=this.renderer.resourceManager.createBuffer(r.ELEMENT_ARRAY_BUFFER,a.getByteCapacity(),r.STATIC_DRAW),n=this.renderer.resourceManager.createBuffer(r.ARRAY_BUFFER,o.getByteCapacity(),r.STREAM_DRAW),p=this.renderer.resourceManager.createMaterial(e.SimpleColorMat,"colorShader"),s=a.uintView,d=t.Consts.MAX_RECTS*t.Consts.INDEX_COUNT;this.vertexDataBuffer=o,this.vertexBufferObject=n,this.indexDataBuffer=a,this.indexBufferObject=i,this.shader=p,n.addAttribute(p.getAttribLocation(r,"aVertexPosition"),2,r.FLOAT,!1,t.Consts.VERTEX_SIZE,0),n.addAttribute(p.getAttribLocation(r,"vUv"),2,r.FLOAT,!1,t.Consts.VERTEX_SIZE,8),n.addAttribute(p.getAttribLocation(r,"aVertexColor"),3,r.UNSIGNED_BYTE,!0,t.Consts.VERTEX_SIZE,16),n.addAttribute(p.getAttribLocation(r,"in_alpha"),1,r.FLOAT,!1,t.Consts.VERTEX_SIZE,20);for(var l=0,u=0;l<d;l+=t.Consts.INDEX_COUNT,u+=t.Consts.VERTEX_COUNT)s[l+0]=u+0,s[l+1]=u+1,s[l+2]=u+2,s[l+3]=u+1,s[l+4]=u+3,s[l+5]=u+2;i.updateResource(s,0)},r}();t.RectBatch=r})(t=e.RectBatcher||(e.RectBatcher={}))})(e||(e={}));var e;(function(e){var t;(function(e){var t=function(){function e(){}return e.VERTEX_SIZE=24,e.INDEX_SIZE=2,e.VERTEX_COUNT=4,e.INDEX_COUNT=6,e.VERTEX_COMPONENT_COUNT=6,e.MAX_SPRITES=2e3,e}();e.Consts=t})(t=e.SpriteBatcher||(e.SpriteBatcher={}))})(e||(e={}));var e;(function(e){var t;(function(t){var r=function(){function r(e,t,r){this.gl=t,this.game=e,this.renderer=r,this.maxSprites=null,this.shader=null,this.vertexBufferObject=null,this.indexBufferObject=null,this.vertexDataBuffer=null,this.indexDataBuffer=null,this.elementCount=0,this.currentTexture2D=null,this.currentSprite=null,this.mask=null,this.vertexCount=0,this.init(this.gl)}return r.prototype.shouldFlush=function(){return!!this.isFull()},r.prototype.isFull=function(){return this.vertexDataBuffer.getByteLength()>=this.vertexDataBuffer.getByteCapacity()},r.prototype.bind=function(e){e?(e.bind(this.gl),e.baseUniforms.pMatrix.value=this.game.camera.pMatrix,e._setTexture(this.currentTexture2D),e.updateUniforms(this.gl)):(this.shader.bind(this.gl),this.shader.baseUniforms.pMatrix.value=this.game.camera.pMatrix,this.shader._setTexture(this.currentTexture2D),this.shader.updateUniforms(this.gl)),this.gl.bindTexture(this.gl.TEXTURE_2D,this.currentTexture2D),this.vertexBufferObject.bind(),this.indexBufferObject.bind()},r.prototype.flush=function(e){var t=this.gl;this.mask&&this.mask.rendermask(t);var r=this.vertexDataBuffer;0===this.elementCount&&0===this.vertexCount||(this.bind(e),this.vertexBufferObject.updateResource(r.floatView,0),t.drawElements(t.TRIANGLES,this.elementCount,t.UNSIGNED_SHORT,0),r.clear(),this.elementCount=0,this.vertexCount=0,this.mask&&(this.mask.endRendermask(t),this.mask=null))},r.prototype.addSprite=function(t,r){(t.mask!==this.mask||this.shader!==r)&&(this.flush(this.shader),this.shader=r),t.mask&&(this.mask=t.mask),this.renderer.setRenderer(this,t.sprite);var o=this.vertexDataBuffer.floatView,a=this.vertexDataBuffer.uintView,i=this.vertexDataBuffer.allocate(24),n=new e.Vector(0,0);mat4.identity(t.mvMatrix),t.getWorldMatrix(t.mvMatrix),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[0],o[i++]=t._uv[1],a[i++]=t.color,o[i++]=t.alpha,n.setTo(0,t.height),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[2],o[i++]=t._uv[3],a[i++]=t.color,o[i++]=t.alpha,n.setTo(t.width,0),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[4],o[i++]=t._uv[5],a[i++]=t.color,o[i++]=t.alpha,n.setTo(t.width,t.height),n=n.multiplyMatrix(t.mvMatrix),o[i++]=n.x,o[i++]=n.y,o[i++]=t._uv[6],o[i++]=t._uv[7],a[i++]=t.color,o[i++]=t.alpha,this.currentTexture2D=this.game.cache.image(t.sprite)._texture,this.currentSprite=t.sprite,this.elementCount+=6},r.prototype.init=function(r){var o=new e.DataBuffer32(t.Consts.VERTEX_SIZE*t.Consts.VERTEX_COUNT*t.Consts.MAX_SPRITES),a=new e.DataBuffer16(t.Consts.INDEX_SIZE*t.Consts.INDEX_COUNT*t.Consts.MAX_SPRITES),i=this.renderer.resourceManager.createBuffer(r.ELEMENT_ARRAY_BUFFER,a.getByteCapacity(),r.STATIC_DRAW),n=this.renderer.resourceManager.createBuffer(r.ARRAY_BUFFER,o.getByteCapacity(),r.STREAM_DRAW),p=this.renderer.resourceManager.createMaterial(e.SpriteMat,"spriteShader"),s=a.uintView,d=t.Consts.MAX_SPRITES*t.Consts.INDEX_COUNT;this.vertexDataBuffer=o,this.vertexBufferObject=n,this.indexDataBuffer=a,this.indexBufferObject=i,this.shader=p,n.addAttribute(p.getAttribLocation(r,"aVertexPosition"),2,r.FLOAT,!1,t.Consts.VERTEX_SIZE,0),n.addAttribute(p.getAttribLocation(r,"vUv"),2,r.FLOAT,!1,t.Consts.VERTEX_SIZE,8),n.addAttribute(p.getAttribLocation(r,"aVertexColor"),3,r.UNSIGNED_BYTE,!0,t.Consts.VERTEX_SIZE,16),n.addAttribute(p.getAttribLocation(r,"in_alpha"),1,r.FLOAT,!1,t.Consts.VERTEX_SIZE,20);for(var l=0,u=0;l<d;l+=t.Consts.INDEX_COUNT,u+=t.Consts.VERTEX_COUNT)s[l+0]=u+0,s[l+1]=u+1,s[l+2]=u+2,s[l+3]=u+1,s[l+4]=u+3,s[l+5]=u+2;i.updateResource(s,0)},r}();t.SpriteBatch=r})(t=e.SpriteBatcher||(e.SpriteBatcher={}))})(e||(e={}))},{}]},{},[1])(1)});
//# sourceMappingURL=XEngine.min.js.map
